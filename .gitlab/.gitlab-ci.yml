variables:
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  BUILD_IMAGE: $INTERNAL_DOCKER_REGISTRY/$INTERNAL_IMAGE_NAME

# Variables used from the "Outside"
# INTERNAL_DOCKER_REGISTRY
# INTERNAL_IMAGE_NAME
# DEPENDENCYTRACK_URL
# DEPENDENCYTRACK_TOKEN

stages:
  - check
  - build
  - deploy

java dependencies:
  stage: check
  image: $BUILD_IMAGE
  script:
    - mvn $MAVEN_CLI_OPTS
      org.cyclonedx:cyclonedx-maven-plugin:2.7.9:makeAggregateBom
    - mvn $MAVEN_CLI_OPTS
      io.github.pmckeown:dependency-track-maven-plugin:1.6.0:upload-bom
      -Ddependency-track.dependencyTrackBaseUrl="$DEPENDENCYTRACK_URL"
      -Ddependency-track.apiKey="$DEPENDENCYTRACK_TOKEN"
    - mvn $MAVEN_CLI_OPTS
      io.github.pmckeown:dependency-track-maven-plugin:1.6.0:metrics
      -Ddependency-track.dependencyTrackBaseUrl="$DEPENDENCYTRACK_URL"
      -Ddependency-track.apiKey="$DEPENDENCYTRACK_TOKEN"
  only:
    - dev-main
    - main
    
check unittests:
  stage: check
  image: $BUILD_IMAGE
  script:
    - mvn $MAVEN_CLI_OPTS clean test
  artifacts:
    when: always
    paths:
      - "*/*/target/surefire-reports/TEST-*.xml"
    reports:
      junit: "*/*/target/surefire-reports/TEST-*.xml"
  only:
    - main
    - dev-main
    - tags
    - merge_requests

build:
  image: $BUILD_IMAGE
  stage: build
  script: 
    - mvn $MAVEN_CLI_OPTS install -DskipTests

job deploy:
  image: $BUILD_IMAGE
  stage: deploy
  script:
    - mvn deploy -DskipTests
  only:
    - tags
